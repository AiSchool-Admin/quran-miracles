name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    name: Claude PR Review
    runs-on: ubuntu-latest
    # Only run if ANTHROPIC_API_KEY secret is configured
    if: ${{ vars.ENABLE_CLAUDE_REVIEW == 'true' }}

    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Extract diff
        id: diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- \
            '*.py' '*.ts' '*.tsx' '*.sql' \
            > /tmp/pr_diff.txt || true
          echo "diff_lines=$(wc -l < /tmp/pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Claude review
        if: ${{ steps.diff.outputs.diff_lines > 0 }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          pip install anthropic
          python scripts/claude_pr_review.py \
            --diff-file /tmp/pr_diff.txt \
            --pr-number $PR_NUMBER \
            --repo $REPO \
            --guidelines-file CLAUDE.md
